#include <stdio.h>

#define BUFFER_S 832

//double input[BUFFER_S] = {84354, 84374, 84380, 84382, 84400, 84400, 84409, 84419, 84415, 84383, 84325, 84273, 84201, 84154, 84119, 84110, 84080, 84066, 84056, 84038, 84025, 84011, 84028, 84004, 84016, 84017, 83991, 83990, 83974, 83979, 83969, 83970, 83963, 83979, 83972, 83989, 83993, 84003, 84003, 84015, 84030, 84042, 84053, 84057, 84067, 84090, 84087, 84102, 84121, 84104, 84081, 84011, 83929, 83893, 83851, 83826, 83821, 83804, 83803, 83784, 83773, 83773, 83758, 83778, 83777, 83795, 83791, 83775, 83783, 83771, 83761, 83777, 83796, 83806, 83818, 83844, 83850, 83863, 83879, 83887, 83894, 83914, 83916, 83929, 83949, 83952, 83951, 83954, 83941, 83889, 83809, 83734, 83691, 83653, 83640, 83613, 83590, 83597, 83580, 83600, 83600, 83609, 83608, 83590, 83611, 83581, 83578, 83577, 83603, 83598, 83607, 83617, 83617, 83642, 83648, 83653, 83655, 83663, 83673, 83696, 83703, 83711, 83720, 83739, 83742, 83757, 83755, 83791, 83789, 83791, 83821, 83816, 83799, 83735, 83658, 83583, 83518, 83466, 83427, 83411, 83404, 83384, 83353, 83328, 83320, 83312, 83323, 83324, 83309, 83321, 83328, 83318, 83329, 83349, 83352, 83358, 83379, 83391, 83405, 83413, 83791, 83457, 83477, 83503, 83516, 83520, 83550, 83560, 83584, 83584, 83588, 83617, 83630, 83646, 83664, 83672, 83688, 83701, 83727, 83727, 83712, 83648, 83565, 83484, 83440, 83394, 83376, 83356, 83354, 83335, 83321, 83303, 83296, 83299, 83312, 83322, 83301, 83303, 83303, 83312, 83321, 83340, 83358, 83369, 83383, 83399, 83410, 83417, 83425, 83442, 83444, 83461, 83478, 83511, 83526, 83537, 83563, 83575, 83602, 83625, 83643, 83614, 83553, 83488, 83424, 83369, 83347, 83349, 83337, 83363, 83388, 83396, 83408, 83420, 83426, 83423, 83434, 83428, 83424, 83418, 83413, 83431, 83444, 83436, 83453, 83465, 83496, 83508, 83521, 83535, 83534, 83542, 83555, 83574, 83590, 83616, 83632, 83657, 83668, 83683, 83708, 83722, 83726, 83755, 83784, 83801, 83816, 83805, 83761, 83681, 83607, 83557, 83505, 83488, 83464, 83443, 83415, 83421, 83399, 83395, 83381, 83400, 83421, 83418, 83430, 83427, 83432, 83428, 83444, 83477, 83491, 83509, 83523, 83540, 83570, 83594, 83609, 83630, 83637, 83666, 83698, 83716, 83720, 83757, 83773, 83798, 83809, 83832, 83841, 83856, 83881, 83899, 83905, 83940, 83960, 83977, 83991, 83986, 83891, 83843, 83782, 83740, 83724, 83699, 83700, 83709, 83695, 83693, 83680, 83702, 83712, 83725, 83733, 83737, 83745, 83745, 83749, 83768, 83776, 83783, 83798, 83813, 83810, 83839, 83844, 83863, 83882, 83897, 83911, 83912, 83919, 83932, 83965, 83986, 84004, 84016, 84046, 84053, 84059, 84078, 84083, 84044, 83965, 83925, 83883, 83858, 83850, 83849, 83855, 83844, 83827, 83836, 83837, 83843, 83857, 83855, 83867, 83874, 83865, 83867, 83871, 83861, 83875, 83890, 83912, 83930, 83935, 83951, 83963, 83986, 83996, 84011, 84029, 84040, 84062, 84092, 84104, 84107, 84132, 84147, 84164, 84188, 84202, 84222, 84251, 84281, 84311, 84311, 84311, 84271, 84226, 84193, 84169, 84139, 84127, 84143, 84126, 84128, 84148, 84138, 84129, 84154, 84174, 84165, 84176, 84192, 84204, 84210, 84217, 84222, 84231, 84253, 84251, 84269, 84277, 84294, 84319, 84326, 84333, 84346, 84363, 84376, 84391, 84412, 84417, 84440, 84462, 84471, 84503, 84522, 84542, 84562, 84572, 84571, 84561, 84532, 84479, 84452, 84438, 84428, 84423, 84433, 84443, 84452, 84452, 84457, 84468, 84483, 84490, 84493, 84496, 84495, 84495, 84488, 84493, 84504, 84511, 84519, 84530, 84554, 84574, 84598, 84609, 84621, 84633, 84644, 84641, 84661, 84672, 84689, 84701, 84704, 84704, 84713, 84726, 84746, 84723, 84672, 84633, 84600, 84583, 84552, 84553, 84559, 84558, 84546, 84539, 84538, 84552, 84549, 84547, 84555, 84549, 84550, 84543, 84548, 84561, 84556, 84573, 84579, 84575, 84591, 84591, 84598, 84616, 84612, 84622, 84632, 84637, 84635, 84645, 84647, 84654, 84676, 84672, 84673, 84693, 84705, 84703, 84715, 84737, 84745, 84752, 84739, 84641, 84590, 84567, 84569, 84547, 84535, 84538, 84524, 84512, 84498, 84492, 84498, 84526, 84526, 84515, 84527, 84535, 84538, 84539, 84537, 84551, 84564, 84568, 84573, 84590, 84598, 84619, 84620, 84631, 84634, 84637, 84660, 84664, 84685, 84695, 84702, 84713, 84727, 84730, 84756, 84755, 84775, 84785, 84794, 84782, 84730, 84690, 84643, 84619, 84591, 84586, 84584, 84577, 84574, 84579, 84569, 84574, 84583, 84577, 84567, 84560, 84552, 84553, 84563, 84565, 84564, 84575, 84583, 84585, 84593, 84582, 84592, 84598, 84593, 84614, 84607, 84618, 84633, 84634, 84626, 84637, 84647, 84654, 84650, 84667, 84681, 84677, 84690, 84669, 84632, 84578, 84530, 84495, 84464, 84444, 84429, 84411, 84395, 84380, 84375, 84376, 84369, 84373, 84368, 84371, 84366, 84369, 84368, 84372, 84396, 84376, 84389, 84403, 84424, 84440, 84452, 84479, 84490, 84499, 84518, 84531, 84541, 84556, 84569, 84570, 84591, 84584, 84618, 84634, 84630, 84661, 84670, 84687, 84707, 84717, 84725, 84744, 84734, 84705, 84650, 84592, 84537, 84500, 84480, 84459, 84454, 84439, 84423, 84403, 84412, 84404, 84410, 84428, 84435, 84425, 84426, 84429, 84425, 84430, 84427, 84428, 84449, 84461, 84471, 84478, 84465, 84486, 84490, 84495, 84486, 84475, 84478, 84461, 84463, 84453, 84450, 84452, 84460, 84459, 84465, 84452, 84460, 84428, 84366, 84299, 84252, 84216, 84179, 84171, 84183, 84175, 84159, 84128, 84140, 84139, 84130, 84128, 84117, 84115, 84120, 84126, 84133, 84121, 84156, 84157, 84181, 84179, 84191, 84210, 84225, 84268, 84278, 84301, 84309, 84326, 84342, 84367, 84364, 84379, 84383, 84415, 84439, 84461, 84486, 84541, 84560, 84575, 84597, 84604, 84561, 84505, 84440, 84378, 84338, 84314, 84314, 84309, 84300, 84286, 84284, 84250, 84241, 84240, 84229, 84227, 84214, 84215, 84209, 84219, 84206, 84210, 84208, 84219, 84234, 84238, 84260, 84286, 84306, 84326, 84334, 84346, 84366, 84376, 84375, 84400, 84422, 84440, 84432, 84455, 84467, 84497, 84517, 84544, 84555, 84572, 84548, 84510, 84441, 84395, 84361, 84327, 84309, 84309, 84301, 84297, 84279, 84276, 84279};
double input[BUFFER_S] = {61742, 61748, 61741, 61734, 61753, 61759, 61754, 61759, 61759, 61779, 61793, 61800, 61792, 61793, 61771, 61718, 61654, 61623, 61610, 61608, 61613, 61619, 61632, 61640, 61634, 61632, 61647, 61649, 61665, 61677, 61680, 61672, 61648, 61674, 61683, 61686, 61701, 61680, 61704, 61710, 61718, 61722, 61717, 61740, 61729, 61730, 61737, 61741, 61745, 61741, 61755, 61751, 61756, 61756, 61764, 61773, 61766, 61772, 61713, 61659, 61612, 61604, 61594, 61616, 61614, 61616, 61616, 61615, 61622, 61637, 61666, 61670, 61688, 61699, 61706, 61694, 61695, 61694, 61703, 61705, 61711, 61722, 61730, 61739, 61750, 61746, 61762, 61755, 61757, 61762, 61750, 61763, 61757, 61760, 61757, 61762, 61781, 61774, 61771, 61774, 61780, 61798, 61785, 61787, 61764, 61709, 61620, 61601, 61588, 61598, 61606, 61605, 61614, 61622, 61608, 61619, 61624, 61641, 61666, 61665, 61697, 61677, 61664, 61682, 61673, 61696, 61719, 61708, 61701, 61731, 61721, 61727, 61725, 61740, 61741, 61732, 61738, 61738, 61751, 61758, 61747, 61752, 61755, 61760, 61761, 61750, 61756, 61757, 61749, 61767, 61757, 61754, 61748, 61718, 61650, 61614, 61592, 61590, 61579, 61600, 61630, 61629, 61621, 61607, 61641, 61655, 61663, 61677, 61670, 61675, 61677, 61669, 61680, 61676, 61685, 61699, 61697, 61709, 61704, 61713, 61715, 61713, 61718, 61712, 61712, 61720, 61724, 61721, 61718, 61740, 61719, 61735, 61727, 61666, 61599, 61573, 61561, 61565, 61576, 61568, 61582, 61588, 61595, 61589, 61593, 61620, 61631, 61637, 61632, 61617, 61619, 61597, 61595, 61578, 61588, 61580, 61573, 61573, 61557, 61548, 61535, 61535, 61542, 61529, 61518, 61537, 61506, 61510, 61506, 61494, 61499, 61497, 61493, 61492, 61493, 61477, 61482, 61467, 61441, 61405, 61374, 61337, 61315, 61303, 61286, 61258, 61257, 61252, 61234, 61226, 61214, 61209, 61204, 61198, 61185, 61202, 61177, 61168, 61182, 61174, 61167, 61167, 61171, 61176, 61178, 61180, 61171, 61182, 61180, 61183, 61198, 61187, 61207, 61208, 61203, 61204, 61213, 61218, 61229, 61230, 61233, 61244, 61236, 61246, 61243, 61227, 61173, 61161, 61126, 61111, 61101, 61092, 61093, 61100, 61086, 61087, 61089, 61088, 61095, 61092, 61102, 61111, 61105, 61104, 61096, 61106, 61117, 61128, 61122, 61124, 61132, 61134, 61132, 61139, 61140, 61147, 61146, 61152, 61169, 61163, 61150, 61175, 61172, 61172, 61175, 61189, 61180, 61193, 61195, 61170, 61162, 61121, 61097, 61086, 61082, 61084, 61067, 61078, 61091, 61088, 61076, 61086, 61093, 61089, 61099, 61092, 61090, 61104, 61097, 61103, 61095, 61105, 61122, 61113, 61127, 61138, 61145, 61163, 61154, 61159, 61157, 61166, 61179, 61181, 61184, 61205, 61218, 61225, 61233, 61238, 61235, 61189, 61159, 61143, 61117, 61104, 61111, 61105, 61101, 61100, 61094, 61085, 61112, 61110, 61113, 61125, 61144, 61118, 61120, 61127, 61129, 61135, 61151, 61146, 61135, 61141, 61143, 61148, 61160, 61153, 61165, 61171, 61165, 61171, 61175, 61186, 61185, 61191, 61191, 61191, 61208, 61201, 61212, 61218, 61217, 61171, 61133, 61123, 61108, 61114, 61096, 61092, 61088, 61079, 61079, 61065, 61079, 61078, 61077, 61084, 61087, 61089, 61080, 61094, 61098, 61090, 61088, 61101, 61118, 61117, 61120, 61126, 61122, 61118, 61120, 61122, 61122, 61141, 61144, 61145, 61152, 61153, 61156, 61160, 61172, 61183, 61184, 61199, 61198, 61178, 61149, 61127, 61116, 61103, 61098, 61093, 61092, 61093, 61100, 61091, 61088, 61097, 61107, 61102, 61094, 61091, 61090, 61092, 61089, 61085, 61094, 61080, 61105, 61101, 61098, 61104, 61102, 61107, 61116, 61102, 61122, 61116, 61113, 61133, 61144, 61138, 61146, 61148, 61147, 61156, 61149, 61123, 61094, 61079, 61079, 61046, 61053, 61045, 61056, 61052, 61075, 61057, 61054, 61077, 61079, 61072, 61070, 61089, 61097, 61092, 61087, 61085, 61103, 61102, 61112, 61116, 61116, 61119, 61124, 61130, 61138, 61135, 61150, 61151, 61150, 61154, 61163, 61152, 61165, 61154, 61180, 61184, 61173, 61202, 61156, 61119, 61103, 61094, 61081, 61087, 61074, 61084, 61073, 61072, 61071, 61061, 61077, 61080, 61090, 61085, 61099, 61104, 61106, 61118, 61121, 61113, 61118, 61138, 61132, 61145, 61139, 61143, 61161, 61159, 61177, 61177, 61175, 61195, 61184, 61191, 61207, 61215, 61221, 61216, 61222, 61223, 61245, 61244, 61261, 61257, 61274, 61272, 61255, 61220, 61208, 61179, 61172, 61171, 61152, 61151, 61158, 61158, 61157, 61153, 61153, 61160, 61176, 61172, 61182, 61175, 61195, 61186, 61190, 61196, 61194, 61205, 61222, 61219, 61210, 61224, 61239, 61250, 61241, 61249, 61246, 61248, 61248, 61250, 61261, 61272, 61267, 61270, 61272, 61274, 61280, 61269, 61241, 61228, 61189, 61199, 61180, 61179, 61172, 61174, 61181, 61172, 61176, 61177, 61192, 61188, 61180, 61183, 61185, 61201, 61196, 61212, 61197, 61212, 61231, 61222, 61239, 61227, 61250, 61248, 61263, 61265, 61275, 61273, 61275, 61270, 61289, 61282, 61273, 61294, 61296, 61304, 61311, 61319, 61304, 61283, 61232, 61233, 61210, 61210, 61197, 61199, 61198, 61190, 61189, 61182, 61195, 61211, 61210, 61203, 61208, 61213, 61222, 61211, 61219, 61222, 61233, 61245, 61226, 61252, 61244, 61259, 61268, 61268, 61263, 61283, 61288, 61295, 61296, 61308, 61294, 61295, 61293, 61292, 61305, 61302, 61322, 61331, 61337, 61306, 61284, 61246, 61232, 61236, 61226, 61225, 61222, 61223, 61214, 61216, 61209, 61216, 61239, 61235, 61234, 61224, 61240, 61239, 61226, 61233, 61234, 61234, 61252, 61253, 61262, 61259, 61271, 61276, 61281, 61275, 61275, 61293, 61283, 61295, 61300, 61309, 61305, 61313, 61308, 61306, 61302, 61278, 61274, 61232, 61220, 61202, 61207, 61206, 61212, 61222, 61222, 61219, 61214, 61229, 61220, 61231, 61235, 61224, 61225, 61229, 61220, 61208, 61223, 61244, 61234, 61238, 61264, 61259, 61259, 61259, 61267, 61272, 61270, 61279, 61263, 61295, 61295, 61309, 61310, 61322, 61308, 61292, 61251, 61230, 61215, 61201, 61193, 61190, 61189, 61186, 61189, 61195, 61183, 61184, 61203, 61220, 61213, 61207, 61222, 61225, 61231, 61230, 61233, 61245, 61240, 61239, 61247, 61257};

double *de_trend(double *array) {
    double base = 1.0 / BUFFER_S;
    double A[BUFFER_S] = {0};

    // least square solution
    // a
    double A_TxA_1_1 = 0;
    // b, c
    double A_TxA_1_2 = 0;
    // d is BUFFER_S;
    double curr_cell;
    // e
    double A_Txb_1_1 = 0;
    // f
    double A_Txb_1_2 = 0;
    // calculate A^T A and A^T b matrices
    for (int i = 0; i < BUFFER_S; i++) {
        curr_cell = base * (i + 1);
        A_TxA_1_1 += curr_cell * curr_cell;
        A_TxA_1_2 += curr_cell;

        A_Txb_1_1 += curr_cell * input[i];
        A_Txb_1_2 += input[i];
        A[i] = curr_cell;
    }
    // least square coefficients A^T A x = A^T b
    double x_1 = (A_TxA_1_2*A_Txb_1_2 - BUFFER_S*A_Txb_1_1) /
                 (A_TxA_1_2*A_TxA_1_2 - A_TxA_1_1*BUFFER_S);

    double x_2 = (A_TxA_1_1*A_Txb_1_2 - A_TxA_1_2*A_Txb_1_1) /
                 (A_TxA_1_1*BUFFER_S - A_TxA_1_2*A_TxA_1_2);

    for (int i=0; i < BUFFER_S; i++) {
        array[i] = input[i] - (A[i] * x_1 + x_2);
    }
    return array;
}


#define SCALE 100
typedef struct {
    unsigned x:1;
} val;

void find_peaks() {
    double array[BUFFER_S] = {0};
    double *a = array;
    a = de_trend(a);
    printf("%f\n", *a);

    int32_t N = BUFFER_S;
    val LSM[BUFFER_S * SCALE];

    for (int32_t i=0; i < BUFFER_S * SCALE; i++) {
        LSM[i].x = 1;
    }

    for (int k=1; k < SCALE + 1; k++) {
        for (int i = 0; i < BUFFER_S - k; i++) {
            LSM[(k-1) * BUFFER_S + i].x &= ((a[i] > a[i + k]) ? 1 : 0);
        }
        for (int i = 0; i < BUFFER_S - k; i++) {
            LSM[(k-1) * BUFFER_S + i + k].x &= ((a[i+k] > a[i]) ? 1 : 0);
        }

    }
// printing
//    for (int i=0; i < SCALE; i++) {
//        printf("%d \t", i);
//        for (int x=0; x < BUFFER_S; x++) {
//            if (LSM[i*BUFFER_S + x].x) {
//                printf("1 ");
//            } else {
//                printf("  ");
//            }
//        }
//        printf("\n");
//    }

    int G[SCALE] = {0};
    for (int i=0; i < SCALE; i++) {
        for (int x=0; x < BUFFER_S; x++) {
            G[i] += LSM[i*BUFFER_S + x].x;
        }
    }

    int max = -1;
    int idx = -1;

    for (int i=BUFFER_S/2, x=0; i > (BUFFER_S/2)-SCALE; i--, x++) {
        G[x] *= i;
        if (G[x] > max) {
            max = G[x];
            idx = x;
        }
    }

    int pks[BUFFER_S];
    for (int i=0; i < BUFFER_S; i++) {
        pks[i] = 1;
    }

    for (int row=0; row < idx; row++) {
        for (int col=0; col < BUFFER_S; col++) {
            if (!LSM[row*BUFFER_S + col].x) {
                pks[col] = 0;
            }
        }
    }

    printf("\n");
    for (int i=0; i < BUFFER_S; i++) {
        if (pks[i]) {
            printf("%d, ", i);
        }
    }
    printf("\n");

    return;

}

int main() {
    printf("Hello, World!\n");
    find_peaks();

    return 0;
}
